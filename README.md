# libgif-fuzz

Система фаззинга библиотеки `giflib` с использованием AFL++ и анализ покрытия кода для выявления уязвимостей безопасности.

## Результаты исследования

### Обнаруженные уязвимости

- **Переполнения буфера** при обработке GIF-файлов с некорректными размерами
- **Утечки памяти** в функциях работы с цветовыми палитрами и расширениями
- **Некорректная обработка** LZW-сжатых данных изображений
- **Проблемы валидации** входных параметров в функциях парсинга

## Требования

- **clang/llvm 14+** (clang, llvm-profdata, llvm-cov)
- **AFL++** (afl-clang-lto, afl-fuzz)
- **lcov** (genhtml)

## Быстрый старт

### 1. Подготовка окружения
```bash
# Сборка giflib
cd ../libgif_repo && make -j$(nproc)
```

### 2. Запуск фаззинга
```bash
cd ../libgif && ./start.sh
```

**Конфигурация фаззеров:**
- Основной мастер с UI: `-M fuzzer01`
- Дополнительные воркеры: `-S fuzzer02`, `-S fuzzer03`, `-S fuzzer04`

## Анализ покрытия кода

### Полный анализ
```bash
./coverage.sh
```
Выполняет компиляцию с инструментацией, прогон всех найденных кейсов, дополнительные тесты и генерацию отчета.

### Гибкие режимы анализа
```bash
./generate_coverage.sh              # полный процесс через профили из out*
./generate_coverage.sh --merge-only # только слияние профилей
./generate_coverage.sh --report-only # только генерация отчета
./generate_coverage.sh --dir out_full # обработка конкретной директории
```

**Результаты покрытия:**
- `coverage/coverage.info` — данные покрытия в формате lcov
- `coverage/html/index.html` — HTML-отчет с детальной статистикой

## Прогон сохранённых тест-кейсов

```bash
./run_testcases.sh           # обработка всех директорий out*
./run_testcases.sh out_full  # обработка конкретной директории
```

## Архитектура системы

### Фаззеры
- **`full_gif_fuzzer.c`** — расширенный фаззер с тестированием:
  - Парсинга и записи GIF-файлов
  - Работы с цветовыми палитрами (ColorMapObject)
  - LZW-декодирования изображений
  - Обработки расширений (ExtensionBlock)
  - Функций управления памятью

- **`gif_fuzzer.c`** — минимальный фаззер для быстрых проверок базовой функциональности

### Скрипты автоматизации
- **`start.sh`** — сборка и запуск AFL++ с множественными воркерами
- **`run_full_fuzzer.sh`** — отдельный сценарий запуска полного фаззера
- **`run_testcases.sh`** — прогон сохранённых кейсов без фаззинга
- **`coverage.sh`** — полный цикл анализа покрытия
- **`generate_coverage.sh`** — гибкий инструмент анализа покрытия

### Структура данных
- **`in/`** — входной корпус тестовых GIF-файлов
- **`out*/`** — результаты AFL++ (краш-кейсы, очередь, статистика)
- **`coverage/`** — профили выполнения и отчёты покрытия

## Технические детали

### Инструментация покрытия
- **Флаги компиляции**: `-fprofile-instr-generate -fcoverage-mapping`
- **Переменная окружения**: `LLVM_PROFILE_FILE` для управления профилями
- **Инструменты анализа**: llvm-profdata, llvm-cov, genhtml

### Настройки AFL++
- **Санитайзеры**: AddressSanitizer, LeakSanitizer
- **Режим**: persistent mode с shared memory
- **Таймауты**: 60 секунд на выполнение
- **Словарь**: `dict` для улучшения мутаций
